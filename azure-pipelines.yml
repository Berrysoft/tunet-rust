# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

jobs:
- job: Build_CLI
  strategy:
    matrix:
      linux-x86:
        imageName: 'ubuntu-18.04'
        target: 'i686-unknown-linux-gnu'
        exeName: 'tunet'
        publishName: 'tunet.linux.i686'
        rustflags: ''
        crosslib: true
        crosslibs: 'gcc-multilib'
      linux-x64:
        imageName: 'ubuntu-18.04'
        target: 'x86_64-unknown-linux-gnu'
        exeName: 'tunet'
        publishName: 'tunet.linux.x86_64'
        rustflags: ''
        crosslib: false
      linux-arm:
        imageName: 'ubuntu-18.04'
        target: 'arm-unknown-linux-gnueabihf'
        exeName: 'tunet'
        publishName: 'tunet.linux.arm'
        rustflags: '-C linker=arm-linux-gnueabihf-gcc'
        crosslib: true
        crosslibs: 'gcc-arm-linux-gnueabihf'
      linux-arm64:
        imageName: 'ubuntu-18.04'
        target: 'aarch64-unknown-linux-gnu'
        exeName: 'tunet'
        publishName: 'tunet.linux.aarch64'
        rustflags: '-C linker=aarch64-linux-gnu-gcc'
        crosslib: true
        crosslibs: 'gcc-aarch64-linux-gnu'
      linux-riscv64:
        imageName: 'ubuntu-18.04'
        target: 'riscv64gc-unknown-linux-gnu'
        exeName: 'tunet'
        publishName: 'tunet.linux.riscv64gc'
        rustflags: '-C linker=riscv64-linux-gnu-gcc'
        crosslib: true
        crosslibs: 'gcc-riscv64-linux-gnu'
      linux-mips:
        imageName: 'ubuntu-18.04'
        target: 'mips-unknown-linux-gnu'
        exeName: 'tunet'
        publishName: 'tunet.linux.mips'
        rustflags: '-C linker=mips-linux-gnu-gcc'
        crosslib: true
        crosslibs: 'gcc-mips-linux-gnu'
      linux-mipsel:
        imageName: 'ubuntu-18.04'
        target: 'mipsel-unknown-linux-gnu'
        exeName: 'tunet'
        publishName: 'tunet.linux.mipsel'
        rustflags: '-C linker=mipsel-linux-gnu-gcc'
        crosslib: true
        crosslibs: 'gcc-mipsel-linux-gnu'
      linux-mips64:
        imageName: 'ubuntu-18.04'
        target: 'mips64-unknown-linux-gnuabi64'
        exeName: 'tunet'
        publishName: 'tunet.linux.mips64'
        rustflags: '-C linker=mips64-linux-gnuabi64-gcc'
        crosslib: true
        crosslibs: 'gcc-mips64-linux-gnuabi64'
      linux-mips64el:
        imageName: 'ubuntu-18.04'
        target: 'mips64el-unknown-linux-gnuabi64'
        exeName: 'tunet'
        publishName: 'tunet.linux.mips64el'
        rustflags: '-C linker=mips64el-linux-gnuabi64-gcc'
        crosslib: true
        crosslibs: 'gcc-mips64el-linux-gnuabi64'
      linux-ppc:
        imageName: 'ubuntu-18.04'
        target: 'powerpc-unknown-linux-gnu'
        exeName: 'tunet'
        publishName: 'tunet.linux.powerpc'
        rustflags: '-C linker=powerpc-linux-gnu-gcc'
        crosslib: true
        crosslibs: 'gcc-powerpc-linux-gnu'
      linux-ppc64le:
        imageName: 'ubuntu-18.04'
        target: 'powerpc64le-unknown-linux-gnu'
        exeName: 'tunet'
        publishName: 'tunet.linux.powerpc64le'
        rustflags: '-C linker=powerpc64le-linux-gnu-gcc'
        crosslib: true
        crosslibs: 'gcc-powerpc64le-linux-gnu'
      linux-s390x:
        imageName: 'ubuntu-18.04'
        target: 's390x-unknown-linux-gnu'
        exeName: 'tunet'
        publishName: 'tunet.linux.s390x'
        rustflags: '-C linker=s390x-linux-gnu-gcc'
        crosslib: true
        crosslibs: 'gcc-s390x-linux-gnu'
      osx-x64:
        imageName: 'macOS-latest'
        target: 'x86_64-apple-darwin'
        exeName: 'tunet'
        publishName: 'tunet.macos.x86_64'
        rustflags: ''
        crosslib: false
      osx-arm64:
        imageName: 'macOS-11'
        target: 'aarch64-apple-darwin'
        exeName: 'tunet'
        publishName: 'tunet.macos.aarch64'
        rustflags: ''
        crosslib: false
      win-x86:
        imageName: 'windows-latest'
        target: 'i686-pc-windows-msvc'
        exeName: 'tunet.exe'
        publishName: 'tunet.win.i686.exe'
        rustflags: '-C target-feature=+crt-static'
        crosslib: false
      win-x64:
        imageName: 'windows-latest'
        target: 'x86_64-pc-windows-msvc'
        exeName: 'tunet.exe'
        publishName: 'tunet.win.x86_64.exe'
        rustflags: '-C target-feature=+crt-static'
        crosslib: false
      win-arm64:
        imageName: 'windows-latest'
        target: 'aarch64-pc-windows-msvc'
        exeName: 'tunet.exe'
        publishName: 'tunet.win.aarch64.exe'
        rustflags: '-C target-feature=+crt-static'
        crosslib: false
  pool:
    vmImage: $(imageName)

  steps:
  - script: |
      sudo apt update
      sudo apt install $(crosslibs)
    displayName: "Install cross-compile libs"
    condition: eq(variables.crosslib, 'true')

  - script: |
      rustup target add $(target)
      cargo build --release --target $(target)
    displayName: 'Build'
    env:
      RUSTFLAGS: $(rustflags)

  - pwsh: cp target/$(target)/release/$(exeName) $(Build.ArtifactStagingDirectory)/$(publishName)
    displayName: 'Copy binaries'

  - task: PublishBuildArtifacts@1
    inputs:
      ArtifactName: 'publish'

- job: FatBinary_CLI
  dependsOn: Build
  condition: succeeded('Build_CLI')
  pool:
    vmImage: 'macOS-11'
  
  steps:
  - task: DownloadPipelineArtifact@2
    inputs:
      artifact: 'publish'
      path: $(Build.SourcesDirectory)/publish

  - script: lipo -create $(Build.SourcesDirectory)/publish/tunet.macos.x86_64 $(Build.SourcesDirectory)/publish/tunet.macos.aarch64 -output $(Build.ArtifactStagingDirectory)/tunet.macos
    displayName: "Create fat binary"

  - task: PublishBuildArtifacts@1
    inputs:
      ArtifactName: 'publish'

- job: Build_GUI
  strategy:
    matrix:
      linux-x64:
        os: 'ubuntu'
        imageName: 'ubuntu-18.04'
        target: 'x86_64-unknown-linux-gnu'
        publishName: 'tunet-gui.linux.x86_64'
      osx-x64:
        os: 'mac'
        imageName: 'maxOS-latest'
        target: 'x86_64-apple-darwin'
        publishName: 'tunet-gui.macos.x86_64'
      win-x64:
        os: 'windows'
        imageName: 'windows-latest'
        target: 'x86_64-pc-windows-msvc'
        publishName: 'tunet-gui.win.x86_64'
  pool:
    vmImage: $(imageName)
  
  steps:
  - script: |
      sudo apt update
      sudo apt install qtbase5-dev libqt5charts5-dev
    displayName: "Install Qt on Linux"
    condition: eq(variables.os, 'ubuntu')

  - script: |
      brew install qt
    displayName: "Install Qt on MacOS"
    condition: eq(variables.os, 'mac')
  
  - script: |
      vcpkg install qtbase[brotli,concurrent,core,dbus,default-features,doubleconversion,freetype,gui,harfbuzz,jpeg,network,openssl,pcre2,png,sql,sql-psql,sql-sqlite,testlib,widgets,zstd]:x64-windows qttools[core]:x64-windows qtcharts[core]:x64-windows
    displayName: "Compile Qt on Windows"
    condition: eq(variables.os, 'windows')
  
  - pwsh: |
      cd tunet-gui
      mkdir build
      cd build
      cmake .. -GNinja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="$(Build.SourcesDirectory)/$(publishName)"
      ninja install
    displayName: "Build"

  - task: PublishBuildArtifacts@1
    inputs:
      ArtifactName: 'publish'
