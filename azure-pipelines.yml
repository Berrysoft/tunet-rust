# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

jobs:
- job: Build
  strategy:
    matrix:
      linux-x64:
        os: 'ubuntu'
        imageName: 'ubuntu-18.04'
        target: 'x86_64-unknown-linux-gnu'
        exeName: 'tunet'
        publishName: 'tunet.linux.x86_64'
        publishGuiName: 'tunet-gui.linux.x86_64'
        preCmakeCmd: ''
        cmakeArgs: '-DUSE_QT5=on -DCMAKE_CXX_COMPILER=g++-11'
      win-x64:
        os: 'windows'
        imageName: 'windows-latest'
        target: 'x86_64-pc-windows-msvc'
        exeName: 'tunet.exe'
        publishName: 'tunet.win.x86_64.exe'
        publishGuiName: 'tunet-gui.win.x86_64'
        preCmakeCmd: |
          call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
        cmakeArgs: '-DCMAKE_PREFIX_PATH="$(Build.BinariesDirectory)/Qt/6.2.1/msvc2019_64"'
  pool:
    vmImage: $(imageName)
  
  steps:
  - script: |
      sudo add-apt-repository ppa:ubuntu-toolchain-r/test
      sudo apt update
      sudo apt install qtbase5-dev libqt5charts5-dev qt5-qmake ninja-build g++-11
    displayName: "Install Qt on Linux"
    condition: eq(variables.os, 'ubuntu')

  - pwsh: |
      python3 -m pip install aqtinstall
      python3 -m aqt install-qt --outputdir $(Build.BinariesDirectory)/Qt windows desktop 6.2.1 win64_msvc2019_64 -m qtcharts
    displayName: "Install Qt on Windows"
    condition: eq(variables.os, 'windows')
  
  - script: |
      rustup target add $(target)
      cargo build --release --target $(target)
      $(preCmakeCmd)
      cd tunet-gui
      mkdir build
      cd build
      cmake .. -GNinja -DCMAKE_BUILD_TYPE=Release -DRUST_TARGET="$(target)" -DCMAKE_INSTALL_PREFIX="$(Build.ArtifactStagingDirectory)/$(publishGuiName)" $(cmakeArgs)
      ninja install
    displayName: "Build"

  - pwsh: cp target/$(target)/release/$(exeName) $(Build.ArtifactStagingDirectory)/$(publishName)
    displayName: 'Copy CLI binaries'

  - task: PublishBuildArtifacts@1
    inputs:
      ArtifactName: 'publish'

- job: Build_Mac
  pool:
    vmImage: 'macOS-11'
  
  steps:
  - script: |
      brew install cmake ninja
      python3 -m pip install aqtinstall
      python3 -m aqt install-qt --outputdir $(Build.BinariesDirectory)/Qt mac desktop 6.2.1 clang_64 -m qtcharts
    displayName: "Install Qt on MacOS"

  - script: |
      rustup target add aarch64-apple-darwin
      cargo build --release --target x86_64-apple-darwin
      cargo build --release --target aarch64-apple-darwin
    displayName: "Build Rust part"

  - script: |
      cd tunet-gui
      mkdir build
      cd build
      mkdir x64
      cd x64
      cmake ../.. -GNinja -DCMAKE_BUILD_TYPE=Release -DRUST_TARGET="x86_64-apple-darwin" -DCMAKE_INSTALL_PREFIX="$(Build.BinariesDirectory)/tunet-gui.macos.x86_64" -DCMAKE_PREFIX_PATH="$(Build.BinariesDirectory)/Qt/6.2.1/macos"
      ninja install
      cd ..
      mkdir arm64
      cd arm64
      cmake ../.. -GNinja -DCMAKE_BUILD_TYPE=Release -DRUST_TARGET="aarch64-apple-darwin" -DCMAKE_INSTALL_PREFIX="$(Build.BinariesDirectory)/tunet-gui.macos.aarch64" -DCMAKE_PREFIX_PATH="$(Build.BinariesDirectory)/Qt/6.2.1/macos" -DCMAKE_OSX_ARCHITECTURES="arm64"
      ninja install
    displayName: "Build C++ part"

  - script: |
      mkdir -p target/release
      lipo -create target/x86_64-apple-darwin/release/tunet target/aarch64-apple-darwin/release/tunet -output target/release/tunet
      cd $(Build.BinariesDirectory)
      mkdir -p tunet-gui.macos
      cp -r tunet-gui.macos.x86_64/bin tunet-gui.macos/
      rm tunet-gui.macos/bin/tunet-gui.app/Contents/MacOS/tunet-gui
      lipo -create tunet-gui.macos.x86_64/bin/tunet-gui.app/Contents/MacOS/tunet-gui tunet-gui.macos.aarch64/bin/tunet-gui.app/Contents/MacOS/tunet-gui -output tunet-gui.macos/bin/tunet-gui.app/Contents/MacOS/tunet-gui
    displayName: "Create fat binary"

  - pwsh: cp target/release/tunet $(Build.ArtifactStagingDirectory)/tunet.macos
    displayName: 'Copy CLI binaries'

  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: '$(Build.BinariesDirectory)/tunet-gui.macos/bin/tunet-gui.app'
      includeRootFolder: true
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/tunet-gui.macos/tunet-gui.app.zip'
    displayName: 'Archive app'

  - task: PublishBuildArtifacts@1
    inputs:
      ArtifactName: 'publish'
