trigger:
  branches:
    include:
      - master
  paths:
    exclude:
      - .github/
      - assets/
      - README.md

jobs:
- job: Build
  strategy:
    matrix:
      win-x64:
        target: 'x86_64-pc-windows-msvc'
        publishName: 'win.x86_64'
        postfix: '.exe'
      win-x86:
        target: 'i686-pc-windows-msvc'
        publishName: 'win.i686'
        postfix: '.exe'
      win-arm64:
        target: 'aarch64-pc-windows-msvc'
        publishName: 'win.aarch64'
        postfix: '.exe'
      linux-x64:
        target: 'x86_64-unknown-linux-gnu'
        publishName: 'linux.x86_64'
        postfix: ''
      linux-arm64:
        target: 'aarch64-unknown-linux-gnu'
        publishName: 'linux.aarch64'
        postfix: ''
  pool:
    vmImage: 'windows-latest'
  
  steps:
  - script: |
      rustup target add $(target)
      cargo build --release --target $(target)
    displayName: "Build"

  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: |
        '$(Build.SourcesDirectory)/target/$(target)/release/tunet$(postfix)'
        '$(Build.SourcesDirectory)/target/$(target)/release/tunet-cui$(postfix)'
        '$(Build.SourcesDirectory)/target/$(target)/release/tunet-gui$(postfix)'
        '$(Build.SourcesDirectory)/target/$(target)/release/tunet-service$(postfix)'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/$(publishName).zip'
    displayName: 'Archive'

  - task: PublishBuildArtifacts@1
    inputs:
      ArtifactName: 'publish'

- job: Build_Mac
  pool:
    vmImage: 'macOS-11'
  
  steps:
  - script: |
      rustup target add x86_64-apple-darwin
      rustup target add aarch64-apple-darwin
      cargo build --release --target x86_64-apple-darwin
      cargo build --release --target aarch64-apple-darwin
    displayName: "Build"

  - script: |
      mkdir -p target/release
      lipo -create target/x86_64-apple-darwin/release/tunet target/aarch64-apple-darwin/release/tunet -output target/release/tunet
      lipo -create target/x86_64-apple-darwin/release/tunet-cui target/aarch64-apple-darwin/release/tunet-cui -output target/release/tunet-cui
      lipo -create target/x86_64-apple-darwin/release/tunet-gui target/aarch64-apple-darwin/release/tunet-gui -output target/release/tunet-gui
      lipo -create target/x86_64-apple-darwin/release/tunet-service target/aarch64-apple-darwin/release/tunet-service -output target/release/tunet-service
    displayName: "Create fat binary"

  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: |
        '$(Build.SourcesDirectory)/target/release/tunet'
        '$(Build.SourcesDirectory)/target/release/tunet-cui'
        '$(Build.SourcesDirectory)/target/release/tunet-gui'
        '$(Build.SourcesDirectory)/target/release/tunet-service'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/mac.universal.zip'
    displayName: 'Archive'

  - task: PublishBuildArtifacts@1
    inputs:
      ArtifactName: 'publish'
